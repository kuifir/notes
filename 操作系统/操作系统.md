## 处理器管理

`处理器`管理是操作系统的重要组成部分，负责管理、调度和分配计算系系统的`处理器`,并控制程序执行。程序以`进程`的形式来占用处理器和系统资源，处理器管理中最重要的是处理器调度，即进程调度，也就是控制、协调进程对处理器的竞争。

进程可被调度在一个处理器上交替地执行，或者多个处理器上并行执行。交替执行和并行执行都是并发的类型。为了提高并发力度和降低并发开销，现代操作系统又引进了`线程`概念，此时进程仍然是资源分配和管理的单位，线程则成为处理器调度的基本单位。

本章简单介绍处理器硬件运行环境后，着重介绍计算系系统的中断机制、Linux系统的中断处理及其实现，接着详细论述线程和进程的基本概念及其实现，最后讨论各个层次的处理器调度算法

### 处理器硬件运行环境-处理器状态

#### 处理器

- 指令系统和寄存器：处理器根据程序计数器的指向从内存中取指令到指令寄存器，然后译码并执行，程序计数器将自动增长或变为转移地址以指明下一条执行指令的地址。每台计算机的机器指令集合称为`指令系统`，反应计算机的功能和处理能力。
  为了实现指令功能，处理器中设置了一组寄存器用作`寻址`或 `存放数据、变量和中间结果`。Intel x86处理器上配置的寄存器有
  - 通用寄存器：EAX、EBX、ECX、和EDX
  - 指针及变址寄存器：ESP、EBP、ESI、和EDI
  - 段选择符寄存器CS、DS、SS、ES、FS和GS
  - 指令寄存器和变址寄存器EIP和EFLAGS
  - 控制寄存器CRO、CR1、CR2和CR3

- 特权指令和非特权指令：计算机系统中配置操作系统后，由于操作系统是系统资源的管理者和控制者，故通常赋予操作系统较高特权，而规定应用程序全限较低。前者可以使用全部机器指令，后者只能使用指令系统子集。应用程序在执行有关资源管理的机器指令时，易于导致系统混乱，造成系统或用户信息被破坏。因此，在多道程序设计环境中，从`资源管理和控制程序执行`的角度出发,必须把指令系统中的指令分成两类：`特权指令和非特权指令`。

  - 特权指令：是指仅在内核态下才能使用的指令，这些指令涉及改变机器状态、修改寄存器内容、启动设备I/O等。执行这些指令不仅影响运行程序自身，而且干扰其他程序及操作系统 。
  - 非特权指令：在目态和管态（内核态和用户态）下都能工作。

  如果应用程序执行特权指令将会导致非法执行而产生保护中断，继而转向操作系统的"用户非法执行特权指令"的异常处理程序进行处理。

- 内核态和用户态：现代计算机中为处理器建立硬件标志位，称为处理器状态位，它通常是程序状态字中的一位。根据执行程序对资源和机器指令的使用权限将处理器设置成不同状态，至少划分为两种状态：内核态和用户态。

- 处理器状态及其转换：

  下列情况会导致处理器从用户态像内核态转换：

  - 程序请求操作系统服务，执行系统调用。
  
  - 在程序运行时，产生中断事件（如I/O操作完成），运行程序被中断，转向中断处理程序处理。
  
  - 程序在运行时产生异常事件（如发生程序性中断，或目态执行特权指令），运行程序被打断，转向异常处理程序工作。
    这三类情况都是通过中断机制发生，可以说`中断和异常是用户态到内核态转换的仅有途径`。当系统产生中断或异常，处理器将做出相应并交换`程序状态字`，此时会导致处理器从用户态转向内核态。中断事件或异常处理程序的程序状态字中的处理器状态位一定是`内核态`,这是在系统初始化时设置的。
  
    
  
    内核态到用户态的转换：计算机通常提供一条称作`加载程序状态字`的特权指令（Intel 86 为iret指令），用来实现从内核态返回用户态，操作系统将控制权转交给应用程序。
  
- 用户栈和核心栈

  - 用户栈

    用户栈是用户进程空间开辟的一块区域，用于保护应用程序的子程序（函数）间相互调用的参数、返回值、返回点以及子程序的局部变量。系统程序要在保护模式下运行，如果只有用户栈在用户空间，没有内核中可用的工作栈的存在，操作系统一切工作都处于用户态下，就很难提供相应的保护措施。

  - 核心栈

    核心栈也叫系统栈或内核栈，是内存中属于操作系统空间的一块区域，其用途包括两方面，一是用于保存中断现场，对于嵌套中断，被中断程序的现场信息依次压入核心栈，中断返回时，逆序弹出；另一方面，是保存操作系统程序（函数）间相互调用的参数、返回值、返回点以及程序局部变量。每个进程被创建捆绑一个核心栈，具有可读可写不可执行属性。核心栈一般大小有限，如Linux系统中为8KB。进程有两个栈：用户占和核心栈，但硬件栈指针仅一个，随着处理器状态转换，栈指针的值同步改变。

#### 程序状态字（Program Status Word,PSW）

程序运行时，其状态不断动态地变化，如当前处于目态还是管态，下一条要执行的指令位置是什么，等等。操作系统将程序运行时的一组动态信息汇集在一起，称为`程序状态字`,并存放在处理器的一组特殊寄存器里，以方便系统的控制和管理。

在Intel x86机器中，PSW由标志寄存器EFLAGS和指令寄存器EIP组成，均为32位。EFLAGS低16位称为FLAGS,可以当作一个单元来处理。

标志划为三组：状态标志，控制标志和系统标志。

- 状态标志使得一条指令的执行结果影响其后指令的执行。
- 控制标志包括DF、VM、RF和IF位。
  - DF(方向标志)：控制串指令操作
  - VM（虚拟8086方式标志）：为1时，从保护模式进入虚拟8086模式
  - TF（步进标志）：为1时，是处理器执行单步操作
  - IF(中断允许标志)：为1时，允许响应中断，否则关中断
- 系统标志与进程管理有关，共三个，分别为IOPL(I/O特权级别标志)、NT（嵌套任务标志）和RF（恢复标志），用于保护模式。

### 计算机中断机制

#### 中断概念

最初中断技术仅作为设备向CPU报告I/O操作情况的一种手段，以免CPU因不断轮询设备而耗费时间，中断的出现解决了主机和设备的并行问题。现在中断技术的应用范围越来越广，在计算机运行过程中许多事件有可能随即发生，如硬件故障、网络通信、人机交互和程序出错等，必须对这些事件及时加以处理。为了请求系统服务、实现并行工作、处理突发事件、满足实时要求，需要打断处理器正常工作流，为此提出中断概念。

`中断（interrupt）`指在程序执行过程中遇到急需处理的事件时，暂时中现行程序在CPU上的运行，转而执行相应的事件处理程序，待处理完成后再返回断点或调度其他程序执行的过程。

#### 中断源分类和区别

由硬件发出或产生的中断称为硬中断，按硬中断事件的来源和实现手段可将中断划分为外中断和内中断。

1. 外中断又称中断或异步中断，是指来自处理器之外的中断信号，包括时钟中断、键盘中断、它机中断和外部设备中断等。外中断又分为可屏蔽中断和不可屏蔽中断，各个中断具有不同中断优先级，表示事件的紧急程度，在处理高一级中断时，往往会部分或全部屏蔽低级终端

2. 内中断又称异常（exception）或同步中断，是指来自处理器内部的中断信号，通常是由于在程序执行过程中，发现与当前指令关联的、不正常的、或错误的实践。内中断可被细分为：
   - 访管中断，有执行系统调用而引起
   - 硬件故障中断，如电源失效、奇偶校验错误、总线超时等
   - 程序性异常，如非法操作、地址越界、页面故障、调试指令、除数为0和浮点溢出等。

所有这些事件均由异常处理程序处理，并且通常依赖于执行程序的当前现场。内中断不能被屏蔽，一旦出现应立即予以响应并进行处理，至于异常处理程序运行时是否屏蔽外部中断或屏蔽哪些中断，可根据异常处理的需要来设定。

最早中断仅对外部设备而言，称为外中断（中断），随着终端适合用范围的扩大，出现了内终端（异常），从而形成了完整的中断系统。由于他们各自产生原因和处理方法的差别越来越大，故把中断和异常区分开来。

内中断和外中断的区别：

1. 中断（外中断）是由与当前运行程序无关的中断信号出发的，系统不确定中断事件的发生时间，故中断与CPU是异步的，CPU对中断的响应完全是被动的。中断的发生与CPU当前状态无关，即可发生在用户态，又可发生在内核态，因为无论系统处于何种状态都需要处理外部设备发来的中断请求，一般来说，中断处理成与所提供的服务不是当前进程所需要，如时钟中断、磁盘中断等。
   异常是由CPU控制单元产生的，源于现行程序执行指令过程中检测到例外。异常与CPU是同步的，允许指令在执行期间响应异常，而且允许多次响应异常，大部分异常发生在用户态，而内核态唯一发生的异常是"缺页异常"。

2. 要求"中断"被快速处理，以便及时响应其他中断信号，所以中断处理程序处理过程中是不能阻塞的；"异常"处于被打断的当前进程上下文中，所提供的服务是当前线程所需要的，所以异常处理程序处理过程中是可以阻塞的。

3. 中断允许发生嵌套，但异常大多为一重；异常处理过程中可能会产生中断，但中断处理过程中绝不会被异常打断。

Intel x86机器上的中断源采用上述分类。

#### 中断和异常的响应及服务

无论是处理器外部产生的中断还是内部出现的异常，或程序执行系统调用自愿访管；无论中断源是被动的还是主动的，CPU响应过程基本上是一致的：在执行完当前指令后，根据中断源所提供的"中断向量"，在内核中找到相应中断服务例程并调度执行。

中断向量由硬件或操作系统预先分配和设置，系统调用所对应的向量则在访管指令中，各种异常向量在CPU的硬件结构中预先规定，这样不同情况就因中断向量不同而区分开来。因此，中断和异常处理可以作为统一模式加以实现。

操作系统如何转到中断处理程序和异常处理程序执行呢？

- 中断： 中断主要有外部设备、时钟部件或其他计算机发出的，发现中断源并产生终端的硬件成为`中断控制器`。这些硬件包括中断逻辑线路和中断寄存器，当前指令执行结束后，CPU会检查中断寄存器是否有中断事件发生，若无中断信号或中断信号被屏蔽，继续执行程序的后续指令，否则将暂停执行当前程序，转向内核的中断处理程序运行。
- 异常：异常是在执行指令时，由于指令本身的原因发生的，指令的控制逻辑和实现线路一旦发现异常情况便转向内核的异常处理程序，这个由硬件对中断和异常事件做出反应的过程称为中断响应。

处理器如何响应中断和异常？

迄今为止，所有计算机系统都采用硬件和软件，及硬件中断控制器和软件中断/异常处理程序相结合的方法实现中断/异常处理。一般来说，中断/异常的响应需要顺序做4件事：

1. 发现中断源。在中断未被屏蔽的前提下，硬件发现中断/异常事件，并由CPU响应中断/异常请求。当发现多个中断源时，将根据预定的中断优先级先后响应中断请求。
2. 保护现场。暂停当前程序运行，硬件将中断点的现场信息（PSW）保存至核心栈，使得中断/异常处理程序在运行时不会破坏被中断程序中的有用信息，以便在处理结束后返回原程序继续运行。
3. 转向中断/异常事件处理程序执行。此时处理器状态已从用户态转换至内核态，中断/异常处理程序开始工作。
4. 恢复现场。
   - 当`中断`处理结束后，恢复原运行程序的PSW，重新返回中断点以便执行后续指令。
   - 当`异常`处理结束后，返回点会因异常类型而异，大部分应用程序指令执行出错时，异常处理会结束进程，不可能回到原程序；如果是执行访管指令，则异常处理完成后返回这条访管指令的下一条指令；对于页面故障，异常处理结束后会返回发生异常的那条指令重新执行。

#### 中断事件处理原则

1. 硬件故障中断： 一般来说，硬件故障中断事件是由硬件故障导致的，如电源故障、内存故障、设备故障等，排除这种故障需要人工干预，如复位、设置或替换。中断处理程序所能做的事情是保护现场，停止设备工作，停止处理器运行，向操作员报告故障信息并对故障造成的破坏进行估计和恢复。
2. 程序性中断：应用程序错误有以下几类：一是语法错误，这可由编译程序发现并报错；二是逻辑错误，可由测试程序发现并报错；三是程序运行过程中产生异常，如定点溢出、阶下溢、除数为0等。不同用户往往有不同的处理要求，借助于信号机制，操作系统可将所捕获的这类中断事件原封不动地转交给应用程序自行处理
3. I/O中断：
   I/O中断的处理原则如下：
   1. I/O操作正常结束。把等待传输的下一个进程设置为就绪，让它占有设备或通道并启动数据传输。
   2. I/O操作发生故障。先向设备发命令索取状态字，分析产生故障的确切原因，再进行复执或请求人工干预。
   3. I/O操作发生异常。分析情况采取相应措施，向操作员报告，如通知操作员换纸、装纸等。
   4. 设备报道或设备结束。表示有设备接入可供使用或设备断开暂停使用，操作系统应修改系统数据结构中相应设备的状态。

4. 访管中断：访管中断是有程序执行访管指令而引起的，表示当前运行程序对操作系统功能的调用，可看作机器指令的一种扩充。访管指令包括操作码和访管参数两部分，前者表示此指令时访管指令，后者则表示具体的访管要求。有的机器在执行访管指令时，将访管参数作为中断字并入PSW，同时送入内存中指定单元，操作系统的访管中断处理程序分析访管参数、进行合法性检查后，按照访管参数具体要求进行相应的处理。不同访管参数对应不同的服务要求，就像机器指令的不同操作码对应不同动作要求一样。系统调用通过访管指令和中断机制来实现，不同机器上系统调用的格式和功能号含义不尽相同，但是都有如下的共性处理流程：
   1. 程序执行访管指令，并通过适当方式指明系统调用号。
   2. 通过中断机制进入访管中断处理程序，现场信息被保护到核心栈，按功能号实现跳转。
   3. 通过系统调用入口地址表找到相应中断服务例程的入口地址
   4. 执行中断服务例程，正常情况下在结束后返回系统调用的下一条指令继续执行。

5. 时钟中断：间隔时钟在每个时间切换点将间隔时钟寄存器的内容减1，通过程序设置此寄存器的初值。当间隔始终寄存器内容为0时，就产生间隔时钟中断，等同于乃中的作用，意味着预定时间已到。

#### 中断优先级和多重中断

1. 中断优先级：
2. 中断屏蔽：中断屏蔽是指禁止CPU响应中断或禁止中断产生。，它的作用，一是延迟或禁止某些终端的相应，系统程序执行过程中不希望产生干扰时间，以免共享数据结构受到破坏，程序运行过程中产生某些事件认为是正常的，不必加以处理；二是协调中断响应与中断处理的关系，确保高优先级中断可以打断低优先级中断，反之却不能；三是防止同级中断相互干扰，在处理某优先级中断事件时，必须屏蔽该级中断，以免造成混乱。
3. 多重中断事件处理：在计算机系统运行过程中可能同时出现多个中断，或者前一个中断尚未处理完，接着又发生新的中断，于是CPU暂停正在运行的中断处理程序，转而执行新的中断处理程序，这就叫做多重中断或中断嵌套。
4. 对于多重中断，可能时同一优先级的不同中断，也可能是不同优先级的中断。对于前者，通常由同一个中断处理程序按照自左至右的顺序逐个处理并清除之；对于后者，可区分不同情况做如下处理
   - 串行处理。在运行一个中断处理程序时，禁止再次发生中断，这可以通过屏蔽中断来实现。这种方法简单可行，终端都严格按顺序串行处理，但并未考虑相对优先级和时间限制的要求。
   - 嵌套处理。对于有些必须处理且优先级更高的中断事件采用屏蔽方法似有不妥，因此往往允许在运行某些中断处理程序时仍然能够响应中断，这时系统应负责保护被中断的中断处理程序现场，然后转向处理新中断事件的中断处理程序，以便在处理结束时可以返回原来的中断处理程序继续运行。嵌套规模一般不要超过三重。
   - 即时处理。在运行中断处理程序时，如果出现程序性中断事件，在一般情况下表明此时中断处理程序有异常，应对其立即响应并进行处理。

### Linux系统的中断处理及实现

#### Linux内核处理流程

#### Linux中断机制

### 进程和线程的基本概念及其实现

### 各个层次的处理器调度算法